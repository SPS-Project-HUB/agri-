<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Smart Agri Vehicle - Complete System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary-green: #2e7d32;
  --light-green: #4caf50;
  --dark-green: #1b5e20;
  --accent-blue: #1e88e5;
  --warning-red: #e53935;
  --neutral-gray: #757575;
  --background: #f5f9f5;
  --card-bg: #ffffff;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--background);
  color: #333;
  line-height: 1.6;
  padding: 0;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
header {
  background: linear-gradient(135deg, var(--dark-green), var(--primary-green));
  color: white;
  padding: 25px 0;
  border-radius: 0 0 20px 20px;
  margin-bottom: 30px;
  text-align: center;
  box-shadow: var(--shadow);
}

header h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

header p {
  font-size: 1.1rem;
  opacity: 0.9;
  max-width: 700px;
  margin: 0 auto;
}

/* Main Layout */
.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 25px;
  margin-bottom: 30px;
}

.card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 25px;
  box-shadow: var(--shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border-top: 5px solid var(--primary-green);
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-hover);
}

.card-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  color: var(--dark-green);
  font-size: 1.4rem;
}

.card-title i {
  font-size: 1.6rem;
}

/* Control Buttons */
.control-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 15px;
}

.control-row {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 10px 0;
}

.btn {
  padding: 14px 20px;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn:active {
  transform: scale(0.98);
}

.btn-primary {
  background: var(--light-green);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-green);
}

.btn-danger {
  background: var(--warning-red);
  color: white;
}

.btn-danger:hover {
  background: #c62828;
}

.btn-blue {
  background: var(--accent-blue);
  color: white;
}

.btn-blue:hover {
  background: #1565c0;
}

.btn-gray {
  background: var(--neutral-gray);
  color: white;
}

.btn-gray:hover {
  background: #616161;
}

.btn-large {
  width: 100%;
  padding: 16px;
  font-size: 1.1rem;
}

/* Sensor Data */
.sensor-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 20px;
}

.sensor-box {
  background: #f1f8e9;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  border-left: 4px solid var(--light-green);
}

.sensor-value {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--primary-green);
  margin: 10px 0;
}

.sensor-unit {
  color: var(--neutral-gray);
  font-size: 0.9rem;
}

/* Data Logger Section */
.data-logger {
  margin-top: 40px;
}

.logger-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.log-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.log-table th {
  background: var(--primary-green);
  color: white;
  padding: 18px 15px;
  text-align: left;
}

.log-table td {
  padding: 15px;
  border-bottom: 1px solid #eee;
}

.log-table tr:last-child td {
  border-bottom: none;
}

.log-table tr:hover {
  background: #f9fdf9;
}

.status-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 8px;
}

.status-active {
  background: #4caf50;
}

.status-inactive {
  background: #e53935;
}

/* ML Prediction Section */
.prediction-card {
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  color: white;
  border-top-color: #2a5298;
}

.prediction-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.prediction-value {
  font-size: 3.5rem;
  font-weight: 800;
  margin: 20px 0;
  color: #fff;
}

.prediction-label {
  font-size: 1.1rem;
  opacity: 0.9;
}

.prediction-footer {
  margin-top: 20px;
  font-size: 0.9rem;
  opacity: 0.8;
}

/* Footer */
footer {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  color: var(--neutral-gray);
  font-size: 0.9rem;
  border-top: 1px solid #e0e0e0;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 16px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.modal-content h3 {
  color: var(--dark-green);
  margin-bottom: 15px;
}

.modal-content p {
  margin-bottom: 20px;
  color: var(--neutral-gray);
}

.close-modal {
  background: var(--warning-red);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  float: right;
}

/* Responsive */
@media (max-width: 768px) {
  .dashboard {
    grid-template-columns: 1fr;
  }
  
  .control-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  header h1 {
    font-size: 2rem;
  }
  
  .card {
    padding: 20px;
  }
  
  .sensor-grid {
    grid-template-columns: 1fr;
  }
}

/* Button animations */
@keyframes buttonPress {
  0% { transform: scale(1); }
  50% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

.button-press {
  animation: buttonPress 0.2s ease;
}

/* Status styles */
.status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  margin-left: 10px;
}

.status-active-badge {
  background: #e8f5e9;
  color: var(--primary-green);
}

.status-inactive-badge {
  background: #ffebee;
  color: var(--warning-red);
}
</style>
</head>

<body>
<div class="container">
  <header>
    <h1><i class="fas fa-tractor"></i> Smart Agriculture Vehicle</h1>
    <p>Complete AI-Powered Farm Management System with Real-Time Controls</p>
  </header>
  
  <div class="dashboard">
    <!-- Vehicle Control Card -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-tractor"></i>
        <h3>Vehicle Control</h3>
        <span class="status-badge status-active-badge" id="vehicle-status">ACTIVE</span>
      </div>
      <p>Manual control of the agricultural vehicle</p>
      
      <div class="control-grid">
        <button class="btn btn-primary" onclick="controlVehicle('FORWARD')">
          <i class="fas fa-arrow-up"></i> Forward
        </button>
        
        <button class="btn btn-primary" onclick="controlVehicle('LEFT')">
          <i class="fas fa-arrow-left"></i> Left
        </button>
        
        <button class="btn btn-danger" onclick="controlVehicle('STOP')">
          <i class="fas fa-stop"></i> STOP
        </button>
        
        <button class="btn btn-primary" onclick="controlVehicle('RIGHT')">
          <i class="fas fa-arrow-right"></i> Right
        </button>
        
        <button class="btn btn-primary" onclick="controlVehicle('BACKWARD')">
          <i class="fas fa-arrow-down"></i> Backward
        </button>
        
        <button class="btn btn-gray" onclick="toggleAutoMode()">
          <i class="fas fa-robot"></i> <span id="auto-mode-text">Auto Mode</span>
        </button>
      </div>
      <div class="status-indicator" style="margin-top: 15px; font-size: 0.9rem; color: var(--neutral-gray);">
        <i class="fas fa-info-circle"></i> Current: <span id="current-action">Stopped</span>
      </div>
    </div>
    
    <!-- Water Control Card -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-tint"></i>
        <h3>Water Control System</h3>
        <span class="status-badge" id="water-status">MANUAL</span>
      </div>
      <p>Manage irrigation based on soil moisture levels</p>
      
      <div class="control-row">
        <button class="btn btn-blue" onclick="setWaterMode('AUTO')">
          <i class="fas fa-cogs"></i> Auto Mode
        </button>
        <button class="btn btn-gray" onclick="setWaterMode('MANUAL')">
          <i class="fas fa-hand-paper"></i> Manual Mode
        </button>
      </div>
      
      <div class="control-row">
        <button class="btn btn-primary" onclick="controlWater('ON')">
          <i class="fas fa-faucet"></i> Water ON
        </button>
        <button class="btn btn-danger" onclick="controlWater('OFF')">
          <i class="fas fa-faucet-drip"></i> Water OFF
        </button>
      </div>
      
      <div class="sensor-box" style="margin-top: 15px;">
        <h4><i class="fas fa-water"></i> Current Soil Moisture</h4>
        <div class="sensor-value" id="soil-moisture">--</div>
        <div class="sensor-unit">Percentage</div>
      </div>
    </div>
    
    <!-- Seed Sprayer Card -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-seedling"></i>
        <h3>Seed Sprayer System</h3>
        <span class="status-badge status-inactive-badge" id="seed-status">OFF</span>
      </div>
      <p>Manual control for precision seeding</p>
      
      <div class="control-row">
        <button class="btn btn-primary btn-large" onclick="controlSeedSprayer('ON')">
          <i class="fas fa-play"></i> Start Seeding
        </button>
        <button class="btn btn-danger btn-large" onclick="controlSeedSprayer('OFF')">
          <i class="fas fa-stop"></i> Stop Seeding
        </button>
      </div>
      
      <div style="margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
        <h4 style="color: var(--dark-green); margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> Seeding Statistics</h4>
        <div style="display: flex; justify-content: space-between;">
          <div>
            <div style="font-size: 0.9rem; color: var(--neutral-gray);">Total Area</div>
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-green);" id="total-area">0 m²</div>
          </div>
          <div>
            <div style="font-size: 0.9rem; color: var(--neutral-gray);">Seeding Time</div>
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-green);" id="seeding-time">0 min</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Live Sensor Data -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-chart-line"></i>
        <h3>Live Sensor Data</h3>
        <span class="status-badge status-active-badge">LIVE</span>
      </div>
      <p>Real-time farm monitoring metrics</p>
      
      <div class="sensor-grid">
        <div class="sensor-box">
          <h4><i class="fas fa-water"></i> Soil Moisture</h4>
          <div class="sensor-value" id="soil">--</div>
          <div class="sensor-unit">Percentage</div>
        </div>
        
        <div class="sensor-box">
          <h4><i class="fas fa-ruler"></i> Obstacle Distance</h4>
          <div class="sensor-value" id="distance">--</div>
          <div class="sensor-unit">Centimeters</div>
        </div>
      </div>
      
      <button class="btn btn-blue" style="margin-top: 15px; width: 100%;" onclick="refreshSensorData()">
        <i class="fas fa-sync-alt"></i> Refresh Sensor Data
      </button>
    </div>
    
    <!-- ML Prediction Card -->
    <div class="card prediction-card">
      <div class="card-title">
        <i class="fas fa-brain"></i>
        <h3>AI Prediction System</h3>
      </div>
      
      <div class="prediction-content">
        <p class="prediction-label">Crop Yield Prediction</p>
        <div class="prediction-value" id="prediction-result">87%</div>
        <p class="prediction-label">Optimal Yield Forecast</p>
        
        <div style="margin-top: 20px; width: 100%;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Irrigation Need:</span>
            <span id="irrigation-need">High</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Fertilizer Timing:</span>
            <span id="fertilizer-timing">3 days</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Harvest Estimate:</span>
            <span id="harvest-estimate">45 days</span>
          </div>
        </div>
        
        <div class="prediction-footer">
          <p><i class="fas fa-info-circle"></i> AI updates predictions every hour based on sensor data</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Data Logger Section -->
  <div class="data-logger">
    <div class="logger-header">
      <div class="card-title">
        <i class="fas fa-database"></i>
        <h3>System Data Logger</h3>
      </div>
      <div>
        <button class="btn btn-blue" onclick="refreshLogs()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-gray" onclick="clearLogs()" style="margin-left: 10px;">
          <i class="fas fa-trash"></i> Clear
        </button>
      </div>
    </div>
    
    <table class="log-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Operation</th>
          <th>Value</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="log-entries">
        <!-- Log entries will be inserted here by JavaScript -->
      </tbody>
    </table>
    
    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
      <div style="color: var(--neutral-gray); font-size: 0.9rem;">
        <i class="fas fa-info-circle"></i> Showing <span id="log-count">0</span> recent logs
      </div>
      <button class="btn btn-primary" onclick="exportLogs()">
        <i class="fas fa-download"></i> Export Logs
      </button>
    </div>
  </div>
  
  <footer>
    <p>Smart Agri Vehicle System &copy; 2023 | Complete Farm Management Solution</p>
    <p>System Status: <span id="system-status">All Systems Operational</span> | Last updated: <span id="update-time">--:--:--</span></p>
  </footer>
</div>

<!-- Modal for emergency stop -->
<div class="modal" id="emergency-modal">
  <div class="modal-content">
    <h3><i class="fas fa-exclamation-triangle" style="color: #e53935;"></i> Emergency Stop Activated</h3>
    <p>All vehicle movement has been stopped. Manual intervention may be required.</p>
    <p>Reason: <span id="stop-reason">Manual emergency stop</span></p>
    <button class="close-modal" onclick="closeEmergencyModal()">Acknowledge</button>
  </div>
</div>

<!-- Firebase Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyB5CnZ3Eg5TLWN6YZpuQVl7fyDm2Vo4M00",
  authDomain: "aaa-agri.firebaseapp.com",
  databaseURL: "https://aaa-agri-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "aaa-agri"
};

/* ===== INIT ===== */
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== GLOBAL STATE ===== */
let systemState = {
  vehicle: {
    mode: 'MANUAL', // AUTO or MANUAL
    currentAction: 'STOPPED',
    isMoving: false
  },
  water: {
    mode: 'MANUAL', // AUTO or MANUAL
    isOn: false,
    lastSoilReading: 0
  },
  seedSprayer: {
    isOn: false,
    startTime: null,
    totalArea: 0,
    totalTime: 0
  },
  sensors: {
    soilMoisture: 0,
    obstacleDistance: 0,
    lastUpdate: null
  },
  logs: [],
  aiPredictions: {
    yield: 87,
    irrigationNeed: 'High',
    fertilizerTiming: '3 days',
    harvestEstimate: '45 days'
  }
};

/* ===== VEHICLE CONTROL FUNCTIONS ===== */
window.controlVehicle = (cmd) => {
  // Add button press animation
  event.target.classList.add('button-press');
  setTimeout(() => event.target.classList.remove('button-press'), 200);
  
  // Update Firebase
  set(ref(db, "control/move"), cmd);
  
  // Update local state
  systemState.vehicle.currentAction = cmd;
  systemState.vehicle.isMoving = cmd !== 'STOP';
  
  // Update UI
  document.getElementById('current-action').textContent = cmd;
  
  // Handle emergency stop
  if (cmd === 'STOP') {
    document.getElementById('vehicle-status').className = 'status-badge status-inactive-badge';
    document.getElementById('vehicle-status').textContent = 'STOPPED';
    
    // Show emergency modal if vehicle was moving
    if (systemState.vehicle.isMoving) {
      showEmergencyModal('Manual emergency stop activated');
    }
  } else {
    document.getElementById('vehicle-status').className = 'status-badge status-active-badge';
    document.getElementById('vehicle-status').textContent = 'MOVING';
  }
  
  // Log the action
  addLogEntry("Vehicle Control", cmd);
  
  // Update ML prediction based on movement
  updatePrediction();
};

window.toggleAutoMode = () => {
  const newMode = systemState.vehicle.mode === 'MANUAL' ? 'AUTO' : 'MANUAL';
  systemState.vehicle.mode = newMode;
  
  // Update Firebase
  set(ref(db, "control/vehicleMode"), newMode);
  
  // Update UI
  const autoModeText = document.getElementById('auto-mode-text');
  autoModeText.textContent = newMode === 'AUTO' ? 'Manual Mode' : 'Auto Mode';
  
  const badge = document.getElementById('vehicle-status');
  badge.textContent = newMode;
  badge.className = newMode === 'AUTO' ? 'status-badge status-active-badge' : 'status-badge';
  
  addLogEntry("Vehicle Mode", `Switched to ${newMode} mode`);
  
  // If switching to auto mode, start autonomous operation
  if (newMode === 'AUTO') {
    simulateAutoMode();
  }
};

function simulateAutoMode() {
  if (systemState.vehicle.mode !== 'AUTO') return;
  
  // Simulate autonomous navigation
  const actions = ['FORWARD', 'LEFT', 'RIGHT', 'STOP'];
  const randomAction = actions[Math.floor(Math.random() * actions.length)];
  
  // Only take action if no obstacle is detected
  if (systemState.sensors.obstacleDistance > 50 || randomAction === 'STOP') {
    controlVehicle(randomAction);
  }
  
  // Continue autonomous mode after delay
  setTimeout(simulateAutoMode, 3000);
}

/* ===== WATER CONTROL FUNCTIONS ===== */
window.setWaterMode = (mode) => {
  // Update Firebase
  set(ref(db, "control/waterMode"), mode);
  
  // Update local state
  systemState.water.mode = mode;
  
  // Update UI
  const badge = document.getElementById('water-status');
  badge.textContent = mode;
  badge.className = mode === 'AUTO' ? 'status-badge status-active-badge' : 'status-badge';
  
  addLogEntry("Water Mode", `Switched to ${mode} mode`);
  
  // If switching to auto mode, start checking soil moisture
  if (mode === 'AUTO') {
    checkSoilMoisture();
  }
};

window.controlWater = (state) => {
  // Update Firebase
  set(ref(db, "control/water"), state);
  
  // Update local state
  systemState.water.isOn = state === 'ON';
  
  // Update UI
  const badge = document.getElementById('water-status');
  if (systemState.water.mode === 'MANUAL') {
    badge.textContent = systemState.water.isOn ? 'ON' : 'OFF';
    badge.className = systemState.water.isOn ? 'status-badge status-active-badge' : 'status-badge status-inactive-badge';
  }
  
  addLogEntry("Water System", state === 'ON' ? 'Turned ON' : 'Turned OFF');
  
  // Update prediction
  updatePrediction();
};

function checkSoilMoisture() {
  if (systemState.water.mode !== 'AUTO') return;
  
  const soilMoisture = systemState.sensors.soilMoisture;
  
  // Auto water control logic
  if (soilMoisture < 30 && !systemState.water.isOn) {
    // Soil is dry, turn water ON
    controlWater('ON');
    addLogEntry("Auto Water", `Turned ON - Soil moisture: ${soilMoisture}%`);
  } else if (soilMoisture > 70 && systemState.water.isOn) {
    // Soil is wet enough, turn water OFF
    controlWater('OFF');
    addLogEntry("Auto Water", `Turned OFF - Soil moisture: ${soilMoisture}%`);
  }
  
  // Continue checking
  setTimeout(checkSoilMoisture, 5000);
}

/* ===== SEED SPRAYER FUNCTIONS ===== */
window.controlSeedSprayer = (state) => {
  // Update Firebase
  set(ref(db, "control/seed"), state);
  
  // Update local state
  const wasOn = systemState.seedSprayer.isOn;
  systemState.seedSprayer.isOn = state === 'ON';
  
  // Handle seeding timer
  if (state === 'ON' && !wasOn) {
    // Starting seeding
    systemState.seedSprayer.startTime = new Date();
    addLogEntry("Seed Sprayer", "Started seeding");
  } else if (state === 'OFF' && wasOn) {
    // Stopping seeding
    const endTime = new Date();
    const duration = (endTime - systemState.seedSprayer.startTime) / 60000; // in minutes
    systemState.seedSprayer.totalTime += duration;
    
    // Calculate area covered (simulation)
    const areaCovered = duration * 10; // 10 m² per minute
    systemState.seedSprayer.totalArea += areaCovered;
    
    // Update UI
    document.getElementById('total-area').textContent = `${Math.round(systemState.seedSprayer.totalArea)} m²`;
    document.getElementById('seeding-time').textContent = `${Math.round(systemState.seedSprayer.totalTime)} min`;
    
    addLogEntry("Seed Sprayer", `Stopped - Covered ${Math.round(areaCovered)} m²`);
  }
  
  // Update UI
  const badge = document.getElementById('seed-status');
  badge.textContent = state === 'ON' ? 'ON' : 'OFF';
  badge.className = state === 'ON' ? 'status-badge status-active-badge' : 'status-badge status-inactive-badge';
  
  // Update prediction
  updatePrediction();
};

/* ===== SENSOR FUNCTIONS ===== */
window.refreshSensorData = () => {
  // Simulate sensor data refresh
  systemState.sensors.soilMoisture = Math.floor(Math.random() * 30) + 40; // 40-70%
  systemState.sensors.obstacleDistance = Math.floor(Math.random() * 150) + 20; // 20-170 cm
  
  // Update UI
  document.getElementById('soil').textContent = systemState.sensors.soilMoisture;
  document.getElementById('distance').textContent = systemState.sensors.obstacleDistance;
  document.getElementById('soil-moisture').textContent = systemState.sensors.soilMoisture;
  
  // Update timestamp
  const now = new Date();
  document.getElementById('update-time').textContent = now.toLocaleTimeString();
  
  addLogEntry("Sensors", "Manual refresh");
  
  // If in auto mode, check water needs
  if (systemState.water.mode === 'AUTO') {
    checkSoilMoisture();
  }
  
  // Update prediction
  updatePrediction();
};

/* ===== ML PREDICTION FUNCTIONS ===== */
function updatePrediction() {
  // Base prediction algorithm
  let prediction = 70; // Base 70%
  
  // Adjust based on soil moisture
  const soil = systemState.sensors.soilMoisture;
  if (soil >= 40 && soil <= 70) prediction += 15;
  else if (soil >= 30 && soil < 40) prediction += 5;
  else if (soil > 70 && soil <= 85) prediction -= 5;
  else prediction -= 15;
  
  // Adjust based on vehicle activity
  if (systemState.vehicle.isMoving) prediction += 5;
  
  // Adjust based on seeding activity
  if (systemState.seedSprayer.isOn) prediction += 3;
  
  // Adjust based on watering
  if (systemState.water.isOn && soil < 50) prediction += 5;
  
  // Ensure bounds
  prediction = Math.max(10, Math.min(98, prediction));
  
  // Update state
  systemState.aiPredictions.yield = Math.round(prediction);
  
  // Update irrigation need
  if (soil < 30) systemState.aiPredictions.irrigationNeed = 'Critical';
  else if (soil < 50) systemState.aiPredictions.irrigationNeed = 'High';
  else if (soil < 70) systemState.aiPredictions.irrigationNeed = 'Moderate';
  else systemState.aiPredictions.irrigationNeed = 'Low';
  
  // Update UI
  document.getElementById('prediction-result').textContent = `${systemState.aiPredictions.yield}%`;
  document.getElementById('irrigation-need').textContent = systemState.aiPredictions.irrigationNeed;
  document.getElementById('fertilizer-timing').textContent = systemState.aiPredictions.fertilizerTiming;
  document.getElementById('harvest-estimate').textContent = systemState.aiPredictions.harvestEstimate;
}

/* ===== DATA LOGGER FUNCTIONS ===== */
const logEntries = [];
const maxLogEntries = 15;

function addLogEntry(operation, value) {
  const timestamp = new Date().toLocaleTimeString();
  const status = value.includes('OFF') || value.includes('STOP') ? 'inactive' : 'active';
  
  logEntries.unshift({ 
    timestamp, 
    operation, 
    value, 
    status,
    fullTimestamp: new Date()
  });
  
  if (logEntries.length > maxLogEntries) {
    logEntries.pop();
  }
  
  updateLogTable();
}

function updateLogTable() {
  const logTable = document.getElementById('log-entries');
  logTable.innerHTML = '';
  
  logEntries.forEach(entry => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${entry.timestamp}</td>
      <td>${entry.operation}</td>
      <td><strong>${entry.value}</strong></td>
      <td>
        <span class="status-indicator ${entry.status === 'active' ? 'status-active' : 'status-inactive'}"></span>
        ${entry.status}
      </td>
    `;
    logTable.appendChild(row);
  });
  
  document.getElementById('log-count').textContent = logEntries.length;
}

window.refreshLogs = () => {
  addLogEntry("Data Logger", "Manual refresh");
};

window.clearLogs = () => {
  if (confirm("Are you sure you want to clear all logs?")) {
    logEntries.length = 0;
    updateLogTable();
    addLogEntry("System", "Logs cleared");
  }
};

window.exportLogs = () => {
  const logsText = logEntries.map(entry => 
    `${entry.fullTimestamp.toISOString()}, ${entry.operation}, ${entry.value}, ${entry.status}`
  ).join('\n');
  
  const blob = new Blob([logsText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `agri-logs-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  addLogEntry("Data Logger", "Exported logs");
};

/* ===== EMERGENCY MODAL FUNCTIONS ===== */
function showEmergencyModal(reason) {
  document.getElementById('stop-reason').textContent = reason;
  document.getElementById('emergency-modal').style.display = 'flex';
}

function closeEmergencyModal() {
  document.getElementById('emergency-modal').style.display = 'none';
}

/* ===== KEYBOARD CONTROLS ===== */
document.addEventListener('keydown', (event) => {
  switch(event.key.toLowerCase()) {
    case 'arrowup':
    case 'w':
      controlVehicle('FORWARD');
      event.preventDefault();
      break;
    case 'arrowleft':
    case 'a':
      controlVehicle('LEFT');
      event.preventDefault();
      break;
    case 'arrowright':
    case 'd':
      controlVehicle('RIGHT');
      event.preventDefault();
      break;
    case 'arrowdown':
    case 's':
      controlVehicle('BACKWARD');
      event.preventDefault();
      break;
    case ' ':
    case 'x':
      controlVehicle('STOP');
      event.preventDefault();
      break;
    case '1':
      controlWater('ON');
      break;
    case '2':
      controlWater('OFF');
      break;
    case '3':
      controlSeedSprayer('ON');
      break;
    case '4':
      controlSeedSprayer('OFF');
      break;
    case 'escape':
      closeEmergencyModal();
      break;
  }
});

/* ===== FIREBASE LISTENERS ===== */
onValue(ref(db, "sensors"), (snapshot) => {
  if (snapshot.exists()) {
    const data = snapshot.val();
    
    // Update sensor displays
    systemState.sensors.soilMoisture = data.soil_percent || systemState.sensors.soilMoisture;
    systemState.sensors.obstacleDistance = data.distance || systemState.sensors.obstacleDistance;
    
    document.getElementById("soil").innerText = systemState.sensors.soilMoisture;
    document.getElementById("distance").innerText = systemState.sensors.obstacleDistance;
    document.getElementById("soil-moisture").innerText = systemState.sensors.soilMoisture;
    
    // Update last updated time
    const now = new Date();
    document.getElementById("update-time").innerText = now.toLocaleTimeString();
    
    // Update prediction
    updatePrediction();
    
    // If in auto mode, check water needs
    if (systemState.water.mode === 'AUTO') {
      checkSoilMoisture();
    }
  }
});

/* ===== INITIALIZATION ===== */
// Initialize with sample data
setTimeout(() => {
  // Add initial log entries
  addLogEntry("System", "Initialized");
  addLogEntry("Vehicle", "Ready for operation");
  addLogEntry("Sensors", "All systems active");
  addLogEntry("AI Model", "Loaded and predicting");
  
  // Initialize sensor data
  systemState.sensors.soilMoisture = 65;
  systemState.sensors.obstacleDistance = 120;
  
  // Update UI
  document.getElementById('soil').textContent = systemState.sensors.soilMoisture;
  document.getElementById('distance').textContent = systemState.sensors.obstacleDistance;
  document.getElementById('soil-moisture').textContent = systemState.sensors.soilMoisture;
  
  // Initialize prediction
  updatePrediction();
  
  // Update system status
  document.getElementById('system-status').textContent = 'All Systems Operational';
  
  // Add keyboard help
  addLogEntry("System", "Keyboard controls: Arrows/WASD=Move, Space/X=Stop, 1/2=Water, 3/4=Seed");
}, 500);
</script>
</body>
</html>
